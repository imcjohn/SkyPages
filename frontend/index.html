<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.2.2/jszip.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src = "bootbox.all.min.js"></script>
    <script src = "ziphandler.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

    <script>
        // code to handle github
        let debounce = function(fun, mil){
            let timer;
            return function(){
                clearTimeout(timer);
                timer = setTimeout(function(){
                    fun();
                }, mil);
            };
        };
        let checkUrl = function(url){
            if (!url.startsWith('https://'))
                return 'Please use an https GitHub Pages URL';
            let chop = url.split('.');
            console.log(chop);
            if (!(chop[1] == 'github' && chop[2].startsWith('io'))){
                return 'Sorry, this only supports Github Pages. Please enter a proper GitHub pages URL';
            }
            return 'ok';
        };
        let processBounced = function(){
            let result = {skylink : "eeb", other_skylinks : ["sk1","skylink two","skilthreee"]};
            handleResult(result);
            return;


            let url = document.getElementById("githubPage").value;
            let status = checkUrl(url);
            if (status != 'ok'){
                bootbox.alert(status);
            }
            let zipPromise = get_pages(url);
            zipPromise.then(handleJZip);
        };
        let processImport = debounce(processBounced,50);
        // code to handle zip
        let handleZip = function(element){
            let file = element.files[0];
            document.getElementsByTagName('label')[0].innerText = file.name;
            if (!file.name.endsWith('.zip')){
                bootbox.alert("Please select a zip file");
            }
            let zipPromise = (new JSZip()).loadAsync(file);
            zipPromise.then(zip => handle_zip(zip)).then(handleResult);
        };
        let handleJZip = function(zip){
            let promResult = handle_zip(zip);
            promResult.then(handleResult);
        };
        // general code
        let handleResult = function(value){
            let other  = ''
            let rawText = 'Primary Skylink: ' + value.skylink + '\nOther Skylinks:\n\t'
            for (var each of value.other_skylinks){
                other = other + `<li><a href="${each}">${each}</a></li>`;
                rawText = rawText + each + '\n\t';
            }
            let b64 = btoa(rawText);
            // value contains value.skylink and value.other_skylinks
            let result = `
            <h1 style='font-family:"Fjalla One", sans-serif;
              font-size:2em;
              font-weight:400;
              color:#00B4DB;
              border-bottom:1px solid #00B4DB;
              margin-bottom:1em;'
            >
            Upload Complete!
            </h1>
            <p>Your Website's Skylink: <a href="${value.skylink}">${value.skylink}</a></p>
            <p>Other Skylinks (for resources etc):</p>
            <ol>
            ${other}
            </ol>
            <a download="skylinks.txt" href="data:application/octet-stream;base64,${b64}">Download skylinks as text</a>
            `;
            bootbox.alert(result);
        }
    </script>

</head>
<body>
<section>
    <div class="container p-5">
        <!-- For demo purpose -->
        <div class="row mb-5 text-center text-white">
            <div class="col-lg-10 mx-auto">
<!--                <img src="logo.png" width="200">-->
                <h1 class="display-4">SkyPages</h1>
                <p class="lead">Hosting your website in a secure, decentralized manner</p>
            </div>
        </div>
        <!-- End -->

        <div class="col-lg-5 mx-auto">
            <div class="p-5 bg-white shadow rounded-lg">
                <img src="upload.jpg" alt="" width="150" class="d-block mx-auto mb-4 rounded-pill">

                <!-- Default bootstrap file upload-->

                <h6 class="text-center mb-4">
                    Select zip folder to upload
                </h6>

                <div class="custom-file overflow-hidden rounded-pill mb-5">
                    <input onchange="handleZip(this)" id="customFile" type="file" class="custom-file-input rounded-pill">
                    <label for="customFile" class="custom-file-label rounded-pill">Choose file</label>
                </div>
                <!-- End -->

                <img src="github_PNG20.png" alt="" width="150" class="d-block mx-auto mb-4 ">

                <h6 class="text-center mb-4 text-muted">
                    Or import from GitHub pages
                </h6>

                <!-- Custom bootstrap upload file-->
                <input type="text" class="form-control btn-block rounded-pill shadow" id="githubPage" placeholder="Enter Github Pages URL">
                <label onclick="processImport();" class="btn btn-primary btn-block rounded-pill shadow"><i class="fa fa-upload mr-2"></i>Import
                </label>
                <!-- End -->

            </div>

        </div>
</section>

</body>
</html>